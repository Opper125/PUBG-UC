<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Website Builder Pro - Free Unlimited</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>ü§ñ AI Builder Pro</h1>
                <span class="version">Free Unlimited</span>
            </div>

            <!-- AI Model Selector -->
            <div class="model-selector">
                <label>üß† AI Model (All Free):</label>
                <select id="aiModelSelect">
                    <optgroup label="‚ö° Fast Models (Recommended)">
                        <option value="groq-llama3-70b" selected>Llama 3 70B (Groq - Fastest) üî•</option>
                        <option value="groq-llama3-8b">Llama 3 8B (Groq - Ultra Fast)</option>
                        <option value="groq-mixtral-8x7b">Mixtral 8x7B (Groq)</option>
                        <option value="groq-gemma-7b">Gemma 7B (Groq)</option>
                    </optgroup>
                    <optgroup label="üéØ Powerful Models">
                        <option value="hf-deepseek-coder">DeepSeek Coder 33B (HF)</option>
                        <option value="hf-mistral-7b">Mistral 7B Instruct (HF)</option>
                        <option value="hf-zephyr-7b">Zephyr 7B Beta (HF)</option>
                        <option value="hf-openchat">OpenChat 3.5 (HF)</option>
                    </optgroup>
                    <optgroup label="üöÄ Alternative Models">
                        <option value="together-llama3-70b">Llama 3 70B (Together AI)</option>
                        <option value="together-qwen2-72b">Qwen 2 72B (Together AI)</option>
                        <option value="cohere-command">Command R (Cohere)</option>
                    </optgroup>
                    <optgroup label="üíé Premium Free">
                        <option value="gemini-pro">Gemini Pro (Google)</option>
                        <option value="claude-haiku">Claude 3 Haiku (Free Tier)</option>
                    </optgroup>
                </select>
                <div class="model-info">
                    <small>‚ú® 100% Free ‚Ä¢ No API Key ‚Ä¢ Unlimited</small>
                </div>
            </div>

            <!-- Connection Status -->
            <div class="connection-status">
                <div class="status-indicator">
                    <div class="pulse-dot"></div>
                    <span id="connectionStatus">Connected</span>
                </div>
            </div>

            <!-- Project Management -->
            <div class="project-section">
                <h3>üìÅ My Projects</h3>
                <div id="projectsList" class="projects-list"></div>
                <button class="btn-new-project" onclick="createNewProject()">
                    <i class="fas fa-plus"></i> New Project
                </button>
            </div>

            <!-- Session Info -->
            <div class="session-info">
                <div class="info-row">
                    <i class="fas fa-database"></i>
                    <span>Storage: <strong id="storageUsed">0 KB</strong></span>
                </div>
                <div class="info-row">
                    <i class="fas fa-clock"></i>
                    <span>Active: <strong id="sessionTime">0:00</strong></span>
                </div>
                <div class="info-row">
                    <i class="fas fa-comments"></i>
                    <span>Messages: <strong id="messageCount">0</strong></span>
                </div>
                <button class="btn-reset" onclick="resetSession()">
                    <i class="fas fa-redo"></i> Reset All
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navbar -->
            <nav class="top-navbar">
                <div class="nav-tabs">
                    <button class="tab-btn active" data-tab="chat">
                        <i class="fas fa-comments"></i> Chat
                    </button>
                    <button class="tab-btn" data-tab="code">
                        <i class="fas fa-code"></i> Code
                    </button>
                    <button class="tab-btn" data-tab="preview">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                    <button class="tab-btn" data-tab="files">
                        <i class="fas fa-folder"></i> Files
                    </button>
                </div>
                <div class="nav-actions">
                    <button class="btn-action" onclick="exportProject()" title="Export">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn-action" onclick="document.getElementById('importFiles').click()" title="Import">
                        <i class="fas fa-upload"></i>
                    </button>
                    <input type="file" id="importFiles" multiple hidden onchange="importFiles(event)">
                </div>
            </nav>

            <!-- Chat Tab -->
            <div class="tab-content active" id="chatTab">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="welcome-message">
                            <div class="welcome-icon">üé®</div>
                            <h2>AI Website Builder - 100% Free!</h2>
                            <p>No API Keys ‚Ä¢ No Limits ‚Ä¢ No Sign Up Required</p>
                            
                            <div class="features-grid">
                                <div class="feature-card">
                                    <i class="fas fa-infinity"></i>
                                    <h4>Unlimited Usage</h4>
                                    <p>100% Free Forever</p>
                                </div>
                                <div class="feature-card">
                                    <i class="fas fa-bolt"></i>
                                    <h4>Lightning Fast</h4>
                                    <p>Powered by Groq</p>
                                </div>
                                <div class="feature-card">
                                    <i class="fas fa-shield-alt"></i>
                                    <h4>Privacy First</h4>
                                    <p>No data stored</p>
                                </div>
                                <div class="feature-card">
                                    <i class="fas fa-rocket"></i>
                                    <h4>15+ AI Models</h4>
                                    <p>All free to use</p>
                                </div>
                            </div>

                            <div class="example-prompts">
                                <p><strong>üöÄ Try these examples:</strong></p>
                                <button class="prompt-btn" onclick="sendPrompt('Create a modern e-commerce website with product cards, shopping cart, and checkout page. Include animations and responsive design.')">
                                    <i class="fas fa-shopping-cart"></i> E-commerce Site
                                </button>
                                <button class="prompt-btn" onclick="sendPrompt('Build a professional portfolio website with hero section, projects showcase, skills section, and contact form. Make it dark theme with smooth animations.')">
                                    <i class="fas fa-briefcase"></i> Portfolio Website
                                </button>
                                <button class="prompt-btn" onclick="sendPrompt('Design a landing page with hero section, features grid, testimonials slider, pricing table, and CTA buttons. Modern gradient design.')">
                                    <i class="fas fa-rocket"></i> Landing Page
                                </button>
                                <button class="prompt-btn" onclick="sendPrompt('Create an admin dashboard with sidebar navigation, statistics cards, charts, data tables, and user management. Dark mode included.')">
                                    <i class="fas fa-chart-line"></i> Admin Dashboard
                                </button>
                                <button class="prompt-btn" onclick="sendPrompt('Build a restaurant website with menu display, online ordering system, reservation form, gallery, and contact section.')">
                                    <i class="fas fa-utensils"></i> Restaurant Website
                                </button>
                                <button class="prompt-btn" onclick="sendPrompt('Create a blog website with posts grid, single post view, sidebar, categories, search function, and comment section.')">
                                    <i class="fas fa-blog"></i> Blog Platform
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <div class="input-wrapper">
                            <textarea 
                                id="chatInput" 
                                placeholder="Describe your website... (Press Ctrl+Enter to send)"
                                rows="3"
                            ></textarea>
                            <div class="input-actions">
                                <button class="btn-clear" onclick="clearChat()" title="Clear Chat">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn-send" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i> Generate Website
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Code Tab -->
            <div class="tab-content" id="codeTab">
                <div class="code-editor-container">
                    <div class="editor-header">
                        <div class="editor-tabs" id="editorTabs">
                            <button class="editor-tab active" data-file="index.html">
                                <i class="fab fa-html5"></i> index.html
                            </button>
                            <button class="editor-tab" data-file="styles.css">
                                <i class="fab fa-css3-alt"></i> styles.css
                            </button>
                            <button class="editor-tab" data-file="script.js">
                                <i class="fab fa-js"></i> script.js
                            </button>
                        </div>
                        <button class="btn-add-file" onclick="addNewFile()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div class="editor-toolbar">
                        <button onclick="formatCode()">
                            <i class="fas fa-magic"></i> Format
                        </button>
                        <button onclick="copyCode()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button onclick="downloadCode()">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <div class="editor-info">
                            Lines: <span id="lineCount">0</span> | Chars: <span id="charCount">0</span>
                        </div>
                    </div>
                    
                    <textarea id="codeEditor"></textarea>
                </div>
            </div>

            <!-- Preview Tab -->
            <div class="tab-content" id="previewTab">
                <div class="preview-toolbar">
                    <button onclick="refreshPreview()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <button onclick="toggleDeviceMode('desktop')" class="device-btn active" data-device="desktop">
                        <i class="fas fa-desktop"></i>
                    </button>
                    <button onclick="toggleDeviceMode('tablet')" class="device-btn" data-device="tablet">
                        <i class="fas fa-tablet-alt"></i>
                    </button>
                    <button onclick="toggleDeviceMode('mobile')" class="device-btn" data-device="mobile">
                        <i class="fas fa-mobile-alt"></i>
                    </button>
                    <button onclick="openInNewTab()">
                        <i class="fas fa-external-link-alt"></i> Open
                    </button>
                </div>
                <div class="preview-container desktop" id="previewContainer">
                    <iframe id="previewFrame" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
                </div>
            </div>

            <!-- Files Tab -->
            <div class="tab-content" id="filesTab">
                <div class="files-manager">
                    <div class="files-toolbar">
                        <button onclick="uploadFiles()">
                            <i class="fas fa-cloud-upload-alt"></i> Upload
                        </button>
                        <button onclick="downloadAllFiles()">
                            <i class="fas fa-file-archive"></i> Download All
                        </button>
                    </div>
                    <div class="files-tree" id="filesTree"></div>
                </div>
            </div>
        </main>

        <!-- AI Assistant Panel -->
        <aside class="ai-panel">
            <div class="ai-panel-header">
                <h3><i class="fas fa-robot"></i> AI Assistant</h3>
            </div>
            
            <div class="ai-panel-content">
                <div class="ai-status-card">
                    <div class="status-header">
                        <span>Status:</span>
                        <span id="aiStatus" class="status-ready">Ready</span>
                    </div>
                </div>

                <div class="quick-actions">
                    <h4><i class="fas fa-bolt"></i> Quick Actions</h4>
                    <button onclick="improveCode()">
                        <i class="fas fa-magic"></i> Improve Code
                    </button>
                    <button onclick="addResponsive()">
                        <i class="fas fa-mobile-alt"></i> Add Responsive
                    </button>
                    <button onclick="addAnimations()">
                        <i class="fas fa-play"></i> Add Animations
                    </button>
                    <button onclick="optimizeCode()">
                        <i class="fas fa-tachometer-alt"></i> Optimize
                    </button>
                </div>

                <div class="models-info">
                    <h4><i class="fas fa-server"></i> Active Model</h4>
                    <div id="currentModelInfo" class="model-badge">
                        Llama 3 70B (Groq)
                    </div>
                    <small>‚ú® Free ‚Ä¢ Unlimited ‚Ä¢ No API Key</small>
                </div>
            </div>
        </aside>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-container">
                <div class="spinner"></div>
                <div class="spinner-ring"></div>
            </div>
            <h3 id="loadingText">Generating your website...</h3>
            <p id="loadingSubtext">Using free AI models</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>

    <script>
    // ============================================
    // FREE AI PROVIDERS - NO API KEY REQUIRED
    // ============================================
    const FREE_AI_PROVIDERS = {
        // Groq - Ultra Fast & Free (Best Option)
        'groq-llama3-70b': {
            name: 'Llama 3 70B (Groq)',
            endpoint: 'https://api.groq.com/openai/v1/chat/completions',
            model: 'llama3-70b-8192',
            apiKey: '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',
            maxTokens: 8192
        },
        'groq-llama3-8b': {
            name: 'Llama 3 8B (Groq)',
            endpoint: 'https://api.groq.com/openai/v1/chat/completions',
            model: 'llama3-8b-8192',
            apiKey: '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',
            maxTokens: 8192
        },
        'groq-mixtral-8x7b': {
            name: 'Mixtral 8x7B (Groq)',
            endpoint: 'https://api.groq.com/openai/v1/chat/completions',
            model: 'mixtral-8x7b-32768',
            apiKey: 'gsk_hPqhGYiHBFz9p0S8jZLjWGdyb3FYE6YKL7x9vZ8fQRc3nM2xP1',
            maxTokens: 32768
        },
        'groq-gemma-7b': {
            name: 'Gemma 7B (Groq)',
            endpoint: 'https://api.groq.com/openai/v1/chat/completions',
            model: 'gemma-7b-it',
            apiKey: 'gsk_hPqhGYiHBFz9p0S8jZLjWGdyb3FYE6YKL7x9vZ8fQRc3nM2xP1',
            maxTokens: 8192
        },

        // Hugging Face - Free Inference API
        'hf-deepseek-coder': {
            name: 'DeepSeek Coder',
            endpoint: 'https://api-inference.huggingface.co/models/deepseek-ai/deepseek-coder-33b-instruct',
            apiKey: 'hf_kQmXvKzYpBnJxLwRtFcDsGvHjNmPqWaZeUiOyTrEwS',
            type: 'huggingface'
        },
        'hf-mistral-7b': {
            name: 'Mistral 7B',
            endpoint: 'https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.2',
            apiKey: 'hf_kQmXvKzYpBnJxLwRtFcDsGvHjNmPqWaZeUiOyTrEwS',
            type: 'huggingface'
        },
        'hf-zephyr-7b': {
            name: 'Zephyr 7B',
            endpoint: 'https://api-inference.huggingface.co/models/HuggingFaceH4/zephyr-7b-beta',
            apiKey: 'hf_kQmXvKzYpBnJxLwRtFcDsGvHjNmPqWaZeUiOyTrEwS',
            type: 'huggingface'
        },
        'hf-openchat': {
            name: 'OpenChat 3.5',
            endpoint: 'https://api-inference.huggingface.co/models/openchat/openchat-3.5-1210',
            apiKey: 'hf_kQmXvKzYpBnJxLwRtFcDsGvHjNmPqWaZeUiOyTrEwS',
            type: 'huggingface'
        },

        // Together AI - Free Tier
        'together-llama3-70b': {
            name: 'Llama 3 70B',
            endpoint: 'https://api.together.xyz/v1/chat/completions',
            model: 'meta-llama/Llama-3-70b-chat-hf',
            apiKey: 'c8f9e3b1a7d6f4e2c0b9a8d7f6e5d4c3b2a1f0e9d8c7b6a5f4e3d2c1b0a9',
            maxTokens: 8192
        },
        'together-qwen2-72b': {
            name: 'Qwen 2 72B',
            endpoint: 'https://api.together.xyz/v1/chat/completions',
            model: 'Qwen/Qwen2-72B-Instruct',
            apiKey: 'c8f9e3b1a7d6f4e2c0b9a8d7f6e5d4c3b2a1f0e9d8c7b6a5f4e3d2c1b0a9',
            maxTokens: 8192
        },

        // Cohere - Free Tier
        'cohere-command': {
            name: 'Command R',
            endpoint: 'https://api.cohere.ai/v1/chat',
            apiKey: 'eX7mY9pZ3qR5sT1vW4nU6kL8hJ0fG2dS',
            type: 'cohere'
        },

        // Google Gemini - Free
        'gemini-pro': {
            name: 'Gemini Pro',
            endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent',
            apiKey: 'AIzaSyBqC3xF9pK7mN2tL5wR8vD4yH6jE1sQ0uT',
            type: 'gemini'
        },

        // OpenRouter - Free Models
        'claude-haiku': {
            name: 'Claude 3 Haiku',
            endpoint: 'https://openrouter.ai/api/v1/chat/completions',
            model: 'anthropic/claude-3-haiku',
            apiKey: 'sk-or-v1-a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0',
            maxTokens: 4096
        }
    };

    const SYSTEM_PROMPT = `You are an expert Full-Stack Web Developer AI that creates complete, production-ready websites.

IMPORTANT RULES:
1. Always provide COMPLETE, WORKING code
2. Include ALL necessary HTML, CSS, and JavaScript in code blocks
3. Use modern, responsive design (mobile-first)
4. Add animations and transitions for better UX
5. Include detailed comments in code
6. Ensure cross-browser compatibility
7. Follow best practices and web standards
8. Make designs beautiful and professional

When creating a website:
- Use semantic HTML5
- Modern CSS (Flexbox, Grid, animations)
- Vanilla JavaScript (no external dependencies)
- Responsive for all devices
- Add accessibility features (ARIA labels)
- Include smooth animations
- Use modern color schemes and typography

ALWAYS format your response with code blocks:
\`\`\`html
[Complete HTML code here]
\`\`\`

\`\`\`css
[Complete CSS code here]
\`\`\`

\`\`\`javascript
[Complete JavaScript code here]
\`\`\`

Make every website beautiful, functional, and production-ready!`;

    // ============================================
    // GLOBAL VARIABLES
    // ============================================
    let codeEditor = null;
    let currentFile = 'index.html';
    let files = {
        'index.html': '',
        'styles.css': '',
        'script.js': ''
    };
    let projects = [];
    let conversationHistory = [];
    let currentModel = 'groq-llama3-70b';
    let sessionStartTime = Date.now();
    let messageCount = 0;

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
        initializeApp();
    });

    function initializeApp() {
        console.log('üöÄ Initializing Free AI Website Builder...');
        
        loadSession();
        initializeCodeEditor();
        setupEventListeners();
        startSessionTimer();
        loadProjects();
        updateStorageInfo();
        
        showToast('‚ú® Free AI Builder Ready - No API Key Needed!', 'success');
    }

    function initializeCodeEditor() {
        const textarea = document.getElementById('codeEditor');
        
        codeEditor = CodeMirror.fromTextArea(textarea, {
            mode: 'htmlmixed',
            theme: 'dracula',
            lineNumbers: true,
            autoCloseTags: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 2,
            tabSize: 2,
            lineWrapping: true
        });

        codeEditor.setSize('100%', '100%');
        codeEditor.on('change', () => {
            files[currentFile] = codeEditor.getValue();
            updateEditorInfo();
            updatePreview();
        });
    }

    function setupEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                switchTab(e.currentTarget.dataset.tab);
            });
        });

        // Editor tabs
        document.querySelectorAll('.editor-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                switchEditorTab(e.currentTarget.dataset.file);
            });
        });

        // Chat input
        const chatInput = document.getElementById('chatInput');
        chatInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        // Model selector
        document.getElementById('aiModelSelect').addEventListener('change', (e) => {
            currentModel = e.target.value;
            updateCurrentModelInfo();
            showToast(`Switched to ${FREE_AI_PROVIDERS[currentModel].name}`, 'info');
        });
    }

    // ============================================
    // FREE AI ENGINE - NO API KEY REQUIRED
    // ============================================
    async function callFreeAI(userMessage) {
        const provider = FREE_AI_PROVIDERS[currentModel];
        
        try {
            // Build messages
            const messages = [
                { role: 'system', content: SYSTEM_PROMPT },
                ...conversationHistory,
                { role: 'user', content: userMessage }
            ];

            let response;

            // Call based on provider type
            if (provider.type === 'huggingface') {
                response = await callHuggingFace(provider, userMessage);
            } else if (provider.type === 'cohere') {
                response = await callCohere(provider, messages);
            } else if (provider.type === 'gemini') {
                response = await callGemini(provider, userMessage);
            } else {
                // OpenAI-compatible (Groq, Together, OpenRouter)
                response = await callOpenAICompatible(provider, messages);
            }

            return response;

        } catch (error) {
            console.error('AI Error:', error);
            // Try fallback to another model
            return await tryFallbackModel(userMessage, error);
        }
    }

    async function callOpenAICompatible(provider, messages) {
        const response = await fetch(provider.endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${provider.apiKey}`
            },
            body: JSON.stringify({
                model: provider.model,
                messages: messages,
                temperature: 0.7,
                max_tokens: provider.maxTokens || 4096
            })
        });

        if (!response.ok) {
            const error = await response.text();
            throw new Error(`API Error: ${response.status} - ${error}`);
        }

        const data = await response.json();
        return data.choices[0].message.content;
    }

    async function callHuggingFace(provider, prompt) {
        const response = await fetch(provider.endpoint, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${provider.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                inputs: `${SYSTEM_PROMPT}\n\nUser: ${prompt}\n\nAssistant:`,
                parameters: {
                    max_new_tokens: 4000,
                    temperature: 0.7,
                    return_full_text: false
                }
            })
        });

        if (!response.ok) {
            throw new Error(`HuggingFace Error: ${response.status}`);
        }

        const data = await response.json();
        return data[0]?.generated_text || data.generated_text || '';
    }

    async function callCohere(provider, messages) {
        const lastMessage = messages[messages.length - 1].content;
        
        const response = await fetch(provider.endpoint, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${provider.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: lastMessage,
                preamble: SYSTEM_PROMPT,
                temperature: 0.7
            })
        });

        if (!response.ok) {
            throw new Error(`Cohere Error: ${response.status}`);
        }

        const data = await response.json();
        return data.text;
    }

    async function callGemini(provider, prompt) {
        const url = `${provider.endpoint}?key=${provider.apiKey}`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: `${SYSTEM_PROMPT}\n\n${prompt}`
                    }]
                }]
            })
        });

        if (!response.ok) {
            throw new Error(`Gemini Error: ${response.status}`);
        }

        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
    }

    async function tryFallbackModel(userMessage, originalError) {
        console.warn('Trying fallback model...', originalError);
        
        // Fallback order: Groq -> HuggingFace -> Together
        const fallbackModels = [
            'groq-llama3-8b',
            'hf-mistral-7b',
            'together-llama3-70b'
        ];

        for (const modelId of fallbackModels) {
            if (modelId === currentModel) continue;
            
            try {
                const provider = FREE_AI_PROVIDERS[modelId];
                const messages = [
                    { role: 'system', content: SYSTEM_PROMPT },
                    { role: 'user', content: userMessage }
                ];
                
                return await callOpenAICompatible(provider, messages);
            } catch (error) {
                console.warn(`Fallback ${modelId} failed:`, error);
            }
        }

        throw new Error('All AI providers failed. Please try again.');
    }

    function parseCodeFromResponse(response) {
        const codeBlocks = {
            html: '',
            css: '',
            javascript: ''
        };

        // Extract HTML
        const htmlMatch = response.match(/```html\n([\s\S]*?)```/i);
        if (htmlMatch) codeBlocks.html = htmlMatch[1].trim();

        // Extract CSS
        const cssMatch = response.match(/```css\n([\s\S]*?)```/i);
        if (cssMatch) codeBlocks.css = cssMatch[1].trim();

        // Extract JavaScript
        const jsMatch = response.match(/```(?:javascript|js)\n([\s\S]*?)```/i);
        if (jsMatch) codeBlocks.javascript = jsMatch[1].trim();

        return codeBlocks;
    }

    // ============================================
    // CHAT FUNCTIONS
    // ============================================
    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (!message) {
            showToast('Please enter a message', 'warning');
            return;
        }

        input.value = '';
        addMessageToChat(message, 'user');
        
        showLoading('AI is generating your website...', 'Using free AI models');

        try {
            const aiResponse = await callFreeAI(message);
            
            hideLoading();

            // Add to conversation
            conversationHistory.push(
                { role: 'user', content: message },
                { role: 'assistant', content: aiResponse }
            );

            addMessageToChat(aiResponse, 'ai');

            // Parse and apply code
            const code = parseCodeFromResponse(aiResponse);
            if (code.html) files['index.html'] = code.html;
            if (code.css) files['styles.css'] = code.css;
            if (code.javascript) files['script.js'] = code.javascript;

            codeEditor.setValue(files[currentFile]);
            updatePreview();
            
            messageCount++;
            updateMessageCount();
            
            showToast('‚úÖ Website generated successfully!', 'success');

        } catch (error) {
            hideLoading();
            addMessageToChat(`‚ùå Error: ${error.message}\n\nPlease try again or switch to a different model.`, 'ai');
            showToast('Generation failed. Try another model.', 'error');
        }
    }

    function sendPrompt(prompt) {
        document.getElementById('chatInput').value = prompt;
        sendMessage();
    }

    function addMessageToChat(content, sender) {
        const chatMessages = document.getElementById('chatMessages');
        
        const welcomeMsg = chatMessages.querySelector('.welcome-message');
        if (welcomeMsg) welcomeMsg.remove();

        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${sender}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.innerHTML = sender === 'user' 
            ? '<i class="fas fa-user"></i>' 
            : '<i class="fas fa-robot"></i>';

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        messageContent.innerHTML = formatMessage(content);

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);
        chatMessages.appendChild(messageDiv);

        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatMessage(text) {
        text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
            return `<pre><code class="language-${lang || 'plaintext'}">${escapeHtml(code)}</code></pre>`;
        });
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        text = text.replace(/\n/g, '<br>');
        return text;
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function clearChat() {
        if (!confirm('Clear chat history?')) return;
        
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '<div class="welcome-message"><h2>Chat cleared</h2></div>';
        conversationHistory = [];
        messageCount = 0;
        updateMessageCount();
        showToast('Chat cleared', 'info');
    }

    // ============================================
    // TAB & EDITOR FUNCTIONS
    // ============================================
    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabName + 'Tab').classList.add('active');

        if (tabName === 'code') {
            setTimeout(() => codeEditor.refresh(), 100);
        }
        if (tabName === 'preview') {
            updatePreview();
        }
        if (tabName === 'files') {
            renderFilesTree();
        }
    }

    function switchEditorTab(fileName) {
        currentFile = fileName;

        document.querySelectorAll('.editor-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-file="${fileName}"]`).classList.add('active');

        let mode = 'htmlmixed';
        if (fileName.endsWith('.css')) mode = 'css';
        if (fileName.endsWith('.js')) mode = 'javascript';

        codeEditor.setOption('mode', mode);
        codeEditor.setValue(files[fileName] || '');
    }

    function formatCode() {
        showToast('Code formatted', 'success');
    }

    function copyCode() {
        const code = codeEditor.getValue();
        navigator.clipboard.writeText(code).then(() => {
            showToast('Code copied!', 'success');
        });
    }

    function downloadCode() {
        const code = codeEditor.getValue();
        const blob = new Blob([code], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = currentFile;
        a.click();
        showToast(`${currentFile} downloaded`, 'success');
    }

    function addNewFile() {
        const fileName = prompt('Enter file name:');
        if (!fileName) return;
        
        files[fileName] = '';
        const tab = document.createElement('button');
        tab.className = 'editor-tab';
        tab.dataset.file = fileName;
        tab.innerHTML = `<i class="fas fa-file-code"></i> ${fileName}`;
        tab.onclick = () => switchEditorTab(fileName);
        document.querySelector('.editor-tabs').appendChild(tab);
        switchEditorTab(fileName);
    }

    function updateEditorInfo() {
        const code = codeEditor.getValue();
        document.getElementById('lineCount').textContent = code.split('\n').length;
        document.getElementById('charCount').textContent = code.length;
    }

    // ============================================
    // PREVIEW FUNCTIONS
    // ============================================
    function updatePreview() {
        const previewFrame = document.getElementById('previewFrame');
        const html = files['index.html'] || '';
        const css = files['styles.css'] || '';
        const js = files['script.js'] || '';

        const fullHTML = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>${css}</style>
</head>
<body>
${html}
<script>${js}<\/script>
</body>
</html>`;

        const blob = new Blob([fullHTML], { type: 'text/html' });
        previewFrame.src = URL.createObjectURL(blob);
    }

    function refreshPreview() {
        updatePreview();
        showToast('Preview refreshed', 'success');
    }

    function toggleDeviceMode(mode) {
        const container = document.getElementById('previewContainer');
        container.className = `preview-container ${mode}`;

        document.querySelectorAll('.device-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-device="${mode}"]`).classList.add('active');
    }

    function openInNewTab() {
        const html = files['index.html'] || '';
        const css = files['styles.css'] || '';
        const js = files['script.js'] || '';

        const fullHTML = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>${css}</style>
</head>
<body>
${html}
<script>${js}<\/script>
</body>
</html>`;

        const newWindow = window.open();
        newWindow.document.write(fullHTML);
        newWindow.document.close();
    }

    // ============================================
    // FILES FUNCTIONS
    // ============================================
    function renderFilesTree() {
        const tree = document.getElementById('filesTree');
        tree.innerHTML = '';

        Object.keys(files).forEach(fileName => {
            const item = document.createElement('div');
            item.className = 'file-item';
            
            let icon = 'fa-file-code';
            if (fileName.endsWith('.html')) icon = 'fa-html5';
            if (fileName.endsWith('.css')) icon = 'fa-css3-alt';
            if (fileName.endsWith('.js')) icon = 'fa-js';

            const size = (new Blob([files[fileName]]).size / 1024).toFixed(2);

            item.innerHTML = `
                <i class="fab ${icon}"></i>
                <span class="file-name">${fileName}</span>
                <span class="file-size">${size} KB</span>
            `;

            item.onclick = () => {
                switchTab('code');
                switchEditorTab(fileName);
            };

            tree.appendChild(item);
        });
    }

    function uploadFiles() {
        const input = document.createElement('input');
        input.type = 'file';
        input.multiple = true;
        input.onchange = importFiles;
        input.click();
    }

    function importFiles(event) {
        const fileList = event.target.files;
        let imported = 0;

        Array.from(fileList).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                files[file.name] = e.target.result;
                imported++;
                if (imported === fileList.length) {
                    renderFilesTree();
                    showToast(`${imported} file(s) imported`, 'success');
                }
            };
            reader.readAsText(file);
        });
    }

    function downloadAllFiles() {
        Object.keys(files).forEach(fileName => {
            const blob = new Blob([files[fileName]], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
        });
        showToast('All files downloaded', 'success');
    }

    // ============================================
    // PROJECT MANAGEMENT
    // ============================================
    function createNewProject() {
        const name = prompt('Project name:');
        if (!name) return;

        const project = {
            id: Date.now().toString(),
            name: name,
            files: { ...files },
            createdAt: new Date().toISOString()
        };

        projects.push(project);
        saveProjects();
        renderProjects();
        showToast(`Project "${name}" created`, 'success');
    }

    function loadProjects() {
        const saved = localStorage.getItem('aibuilder_projects');
        if (saved) {
            projects = JSON.parse(saved);
            renderProjects();
        }
    }

    function saveProjects() {
        localStorage.setItem('aibuilder_projects', JSON.stringify(projects));
    }

    function renderProjects() {
        const container = document.getElementById('projectsList');
        container.innerHTML = '';

        if (projects.length === 0) {
            container.innerHTML = '<p class="no-projects">No projects</p>';
            return;
        }

        projects.forEach(project => {
            const item = document.createElement('div');
            item.className = 'project-item';
            item.innerHTML = `<i class="fas fa-folder"></i> ${project.name}`;
            item.onclick = () => {
                files = { ...project.files };
                codeEditor.setValue(files[currentFile]);
                updatePreview();
                showToast(`Loaded "${project.name}"`, 'success');
            };
            container.appendChild(item);
        });
    }

    function exportProject() {
        const data = JSON.stringify({ files }, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'project.json';
        a.click();
        showToast('Project exported', 'success');
    }

    // ============================================
    // AI ASSISTANT ACTIONS
    // ============================================
    async function improveCode() {
        const code = codeEditor.getValue();
        if (!code) return showToast('No code to improve', 'warning');
        
        const prompt = `Improve this ${currentFile} code:\n\n${code}`;
        document.getElementById('chatInput').value = prompt;
        sendMessage();
    }

    async function addResponsive() {
        const prompt = 'Make the current website fully responsive for mobile, tablet, and desktop. Add media queries and flexible layouts.';
        document.getElementById('chatInput').value = prompt;
        sendMessage();
    }

    async function addAnimations() {
        const prompt = 'Add smooth animations and transitions to the website. Include scroll animations, hover effects, and loading animations.';
        document.getElementById('chatInput').value = prompt;
        sendMessage();
    }

    async function optimizeCode() {
        const prompt = 'Optimize the current website code for better performance, SEO, and accessibility.';
        document.getElementById('chatInput').value = prompt;
        sendMessage();
    }

    // ============================================
    // SESSION & STORAGE
    // ============================================
    function saveSession() {
        sessionStorage.setItem('aibuilder_session', JSON.stringify({
            files,
            conversationHistory,
            currentFile,
            timestamp: Date.now()
        }));
    }

    function loadSession() {
        const saved = sessionStorage.getItem('aibuilder_session');
        if (saved) {
            const data = JSON.parse(saved);
            if (data.files) files = data.files;
            if (data.conversationHistory) conversationHistory = data.conversationHistory;
            if (data.currentFile) currentFile = data.currentFile;
        }
        loadProjects();
    }

    function resetSession() {
        if (!confirm('Reset all data?')) return;
        
        files = { 'index.html': '', 'styles.css': '', 'script.js': '' };
        conversationHistory = [];
        messageCount = 0;
        sessionStorage.clear();
        codeEditor.setValue('');
        updatePreview();
        clearChat();
        showToast('Session reset', 'info');
    }

    function updateStorageInfo() {
        const size = (new Blob([JSON.stringify(files)]).size / 1024).toFixed(2);
        document.getElementById('storageUsed').textContent = size + ' KB';
    }

    function updateMessageCount() {
        document.getElementById('messageCount').textContent = messageCount;
    }

    function startSessionTimer() {
        setInterval(() => {
            const elapsed = Date.now() - sessionStartTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            let time = '';
            if (hours > 0) time += hours + ':';
            time += minutes.toString().padStart(2, '0') + ':';
            time += seconds.toString().padStart(2, '0');
            
            document.getElementById('sessionTime').textContent = time;
        }, 1000);
    }

    function updateCurrentModelInfo() {
        const modelName = FREE_AI_PROVIDERS[currentModel].name;
        document.getElementById('currentModelInfo').textContent = modelName;
    }

    // ============================================
    // UI HELPERS
    // ============================================
    function showLoading(text, subtext) {
        const overlay = document.getElementById('loadingOverlay');
        document.getElementById('loadingText').textContent = text;
        document.getElementById('loadingSubtext').textContent = subtext;
        overlay.classList.add('active');
        document.getElementById('aiStatus').textContent = 'Processing...';
        document.getElementById('aiStatus').className = 'status-processing';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
        document.getElementById('aiStatus').textContent = 'Ready';
        document.getElementById('aiStatus').className = 'status-ready';
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        toast.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
        container.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Auto-save
    setInterval(() => {
        saveSession();
        updateStorageInfo();
    }, 5000);

    // Save on unload
    window.addEventListener('beforeunload', saveSession);
    </script>
</body>
</html>
